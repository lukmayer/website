<div id="utterances-container"></div>

<script>
function getQuartoTheme() {
  return document.body.classList.contains('quarto-dark') ? 'dark' : 'light';
}

function getUtterancesTheme(theme) {
  return theme === 'dark' ? 'github-dark' : 'github-light';
}

function loadUtterances() {
  const container = document.getElementById('utterances-container');
  container.innerHTML = ''; 

  const script = document.createElement('script');
  script.src = 'https://utteranc.es/client.js';
  script.setAttribute('repo', 'lukmayer/site_comments');
  script.setAttribute('issue-term', 'pathname');
  script.setAttribute('theme', getUtterancesTheme(getQuartoTheme()));
  script.setAttribute('crossorigin', 'anonymous');
  script.setAttribute('async', '');

  container.appendChild(script);
}

function updateUtterancesTheme() {
  const iframe = document.querySelector('.utterances-frame');
  if (iframe) {
    const theme = getUtterancesTheme(getQuartoTheme());
    iframe.contentWindow.postMessage(
      { type: 'set-theme', theme: theme },
      'https://utteranc.es'
    );
  }
}

const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.type === 'attributes' && 
        (mutation.attributeName === 'class' || mutation.attributeName === 'data-bs-theme')) {
      updateUtterancesTheme();
    }
  });
});

observer.observe(document.body, {
  attributes: true,
  attributeFilter: ['class', 'data-bs-theme']
});

observer.observe(document.documentElement, {
  attributes: true,
  attributeFilter: ['class', 'data-bs-theme']
});

document.addEventListener('DOMContentLoaded', loadUtterances);
</script>
