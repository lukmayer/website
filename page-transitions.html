<script>
document.addEventListener("DOMContentLoaded", function() {
  // Ensure specific elements start with opacity 0
  const elementsToHide = document.querySelectorAll(
    '.content.quarto-banner-title-block, .quarto-title-banner.page-columns.page-full, #quarto-content'
  );

  elementsToHide.forEach(element => {
    element.style.opacity = '0'; // Start with opacity 0
  });

  // Trigger fadein animation after the current page is fully loaded
  setTimeout(function() {
    elementsToHide.forEach(element => {
      element.style.transition = 'opacity 1s ease'; // Add transition for smooth fade-in
      element.style.opacity = '1'; // Fade in the elements
    });

    document.body.classList.remove('preload');
  }, 200); // Short delay to ensure smooth transition

  // Adjust timing if necessary
});

</script>


<script>

// pop-up link preview
document.addEventListener('DOMContentLoaded', function() {
  // Normalize the current page URL: remove hash and handle index.html
  let currentPageUrl = window.location.href.split('#')[0];
  // Remove index.html from the end if present
  currentPageUrl = currentPageUrl.replace(/\/index\.html$/, '/');
  // Ensure URL ends with trailing slash for consistency
  if (!currentPageUrl.endsWith('/')) {
    currentPageUrl += '/';
  }

  console.log("Normalized current page URL:", currentPageUrl);

  // Create preview container
  const previewContainer = document.createElement('div');
  previewContainer.className = 'link-preview-container';
  previewContainer.style.cssText = `
    position: fixed;
    width: 80vw;
    height: 80vh;
    background: #1e1e1e;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 10000;
    overflow: hidden;
    display: none;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  `;
  document.body.appendChild(previewContainer);

  // Create title bar
  const titleBar = document.createElement('div');
  titleBar.className = 'preview-title-bar';
  titleBar.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: #252525;
    border-bottom: 1px solid #444;
    padding: 0 50px;
    display: flex;
    align-items: center;
    color: #eee;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
  `;
  previewContainer.appendChild(titleBar);

  // Create close button - positioned relative to the title bar
  const closeButton = document.createElement('div');
  closeButton.className = 'preview-close-button';
  closeButton.style.cssText = `
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    background: #333;
    border-radius: 50%;
    text-align: center;
    line-height: 28px;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    z-index: 10001;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    color: #ddd;
    transition: background 0.2s, color 0.2s;
  `;
  closeButton.textContent = '×';
  // Hover effect for close button
  closeButton.onmouseover = function() { 
    this.style.background = '#555'; 
    this.style.color = '#fff';
  };
  closeButton.onmouseout = function() { 
    this.style.background = '#333'; 
    this.style.color = '#ddd';
  };
  titleBar.appendChild(closeButton);

  // Create title text container (left-aligned)
  const titleText = document.createElement('div');
  titleText.className = 'preview-title-text';
  titleText.style.cssText = `
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding-right: 10px;
  `;
  titleBar.appendChild(titleText);

  // Create "Open in New Tab" button (center-aligned)
  const openButton = document.createElement('button');
  openButton.className = 'preview-open-button';
  openButton.style.cssText = `
    background: #333;
    color: #ddd;
    border: none;
    border-radius: 4px;
    padding: 5px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 0 auto;
    font-weight: normal;
  `;

  // Add black and white icon to button (using Unicode external link symbol)
  const openIcon = document.createElement('span');
  openIcon.textContent = '⧉';  // Unicode "VIEWDATA SQUARE" symbol
  openIcon.style.cssText = `
    font-size: 15px;
    font-weight: bold;
  `;
  openButton.appendChild(openIcon);

  // Add text to button
  const openText = document.createElement('span');
  openText.textContent = 'Open in New Tab';
  openButton.appendChild(openText);

  // Hover effect for open button (matching close button)
  openButton.onmouseover = function() { 
    this.style.background = '#555'; 
    this.style.color = '#fff';
  };
  openButton.onmouseout = function() { 
    this.style.background = '#333'; 
    this.style.color = '#ddd';
  };

  titleBar.appendChild(openButton);

  // Add empty div to balance the layout (right-aligned)
  const spacer = document.createElement('div');
  spacer.style.cssText = `
    flex: 1;
  `;
  titleBar.appendChild(spacer);

  // Create iframe container
  const iframeContainer = document.createElement('div');
  iframeContainer.style.cssText = `
    width: 100%;
    height: calc(100% - 40px);
    margin-top: 40px;
    background: #1e1e1e;
    position: relative;
  `;
  previewContainer.appendChild(iframeContainer);

  // Create iframe
  const iframe = document.createElement('iframe');
  iframe.style.cssText = `
    width: 100%;
    height: 100%;
    border: none;
    background: #1e1e1e;
  `;
  iframeContainer.appendChild(iframe);

  // Add loading indicator
  const loadingIndicator = document.createElement('div');
  loadingIndicator.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #aaa;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    z-index: 10000;
  `;

  // Add loading spinner
  const spinner = document.createElement('div');
  spinner.style.cssText = `
    width: 40px;
    height: 40px;
    border: 4px solid #333;
    border-top: 4px solid #aaa;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  `;
  loadingIndicator.appendChild(spinner);

  // Add loading text
  const loadingText = document.createElement('div');
  loadingText.textContent = 'Loading preview...';
  loadingIndicator.appendChild(loadingText);

  // Add spinner animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  iframeContainer.appendChild(loadingIndicator);

  // Track current link, timeout, and popup state
  let currentLink = null;
  let previewTimeout = null;
  let isPopupOpen = false; // Track if a popup is currently open

  // Close button event
  closeButton.addEventListener('click', function() {
    previewContainer.style.display = 'none';
    iframe.src = 'about:blank';
    currentLink = null;
    isPopupOpen = false; // Update popup state
    console.log("Popup closed");
  });

  // Open in new tab button event
  openButton.addEventListener('click', function() {
    if (currentLink) {
      window.open(currentLink.href, '_blank');
    }
  });

  // Escape key to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && previewContainer.style.display === 'block') {
      previewContainer.style.display = 'none';
      iframe.src = 'about:blank';
      currentLink = null;
      isPopupOpen = false; // Update popup state
      console.log("Popup closed with Escape key");
    }
  });

  // Helper function to normalize URLs for comparison
  function normalizeUrl(url) {
    // Remove hash fragment
    let normalized = url.split('#')[0];
    // Remove index.html
    normalized = normalized.replace(/\/index\.html$/, '/');
    // Ensure trailing slash
    if (!normalized.endsWith('/')) {
      normalized += '/';
    }
    return normalized.toLowerCase(); // Convert to lowercase for case-insensitive comparison
  }

  // Helper function to check if an element is inside the preview container
  function isInsidePreview(element) {
    let current = element;
    while (current) {
      if (current === previewContainer) {
        return true;
      }
      current = current.parentElement;
    }
    return false;
  }

  // Find all links
  const links = document.querySelectorAll('a[href]');

  links.forEach(link => {
    // Show preview on hover
    link.addEventListener('mouseenter', function(e) {
      // Clear any existing timeout
      if (previewTimeout) {
        clearTimeout(previewTimeout);
      }

      // Skip if a popup is already open
      if (isPopupOpen) {
        console.log("Popup already open, skipping new preview");
        return;
      }

      // Skip if this link is inside a preview container
      if (isInsidePreview(link)) {
        console.log("Link is inside preview, skipping nested preview");
        return;
      }

      // Skip empty links, javascript: links, or anchor-only links
      if (!link.href || link.href.startsWith('javascript:') || link.href === '#') {
        return;
      }

      // Normalize the link URL for comparison
      const normalizedLinkUrl = normalizeUrl(link.href);

      console.log("Comparing:", normalizedLinkUrl, "with", currentPageUrl);

      // Skip if link points to current page (after normalization)
      if (normalizedLinkUrl === currentPageUrl) {
        console.log("MATCH - Skipping preview for:", link.href);
        return;
      }

      // Fix for homepage: Don't skip links that point to subpages
      const isHomepage = window.location.pathname === '/' || 
                         window.location.pathname === '/index.html';
      const isSubpage = normalizedLinkUrl.includes(window.location.hostname + '/') && 
                        normalizedLinkUrl !== normalizeUrl(window.location.origin + '/');

      // Set timeout for preview (2 second delay)
      previewTimeout = setTimeout(() => {
        console.log("Opening preview for:", link.href);
        currentLink = link;
        isPopupOpen = true; // Update popup state

        // Set title
        titleText.textContent = link.textContent || link.href;

        // Show container and loading indicator
        previewContainer.style.display = 'block';
        loadingIndicator.style.display = 'flex';

        // Load URL in iframe
        iframe.src = 'about:blank'; // Start with blank page
        setTimeout(() => {
          iframe.src = link.href; // Then load actual URL

          // Hide loading indicator when iframe loads
          iframe.onload = function() {
            loadingIndicator.style.display = 'none';

            // Disable all links inside the iframe to prevent nested popups
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

              // Add a style to disable pointer events on all links
              const disableLinksStyle = iframeDoc.createElement('style');
              disableLinksStyle.textContent = `
                a { 
                  pointer-events: none !important;
                  cursor: default !important;
                }
              `;
              iframeDoc.head.appendChild(disableLinksStyle);
            } catch (e) {
              console.log("Could not disable links in iframe due to cross-origin policy");
            }
          };
        }, 100);
      }, 2000); // Changed to 2000ms (2 seconds) delay
    });

    // Clear timeout on mouse leave
    link.addEventListener('mouseleave', function() {
      if (previewTimeout) {
        clearTimeout(previewTimeout);
      }
    });
  });

  // When iframe is loaded, we need to prevent links inside it from opening new popups
  iframe.addEventListener('load', function() {
    try {
      // Try to access iframe content (may fail due to cross-origin policy)
      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

      // Find all links in the iframe
      const iframeLinks = iframeDoc.querySelectorAll('a[href]');

      // Disable click events on all links
      iframeLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          console.log("Link click prevented in iframe");
          return false;
        });
      });
    } catch (e) {
      console.log("Could not access iframe content due to cross-origin policy");
    }
  });
});


</script>